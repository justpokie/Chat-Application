<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>PokiChat</title>
  <link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;700;800&family=DM+Mono:wght@300;400;500&display=swap" rel="stylesheet"/>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg: #0d0d0f;
      --surface: #141416;
      --border: #222226;
      --accent: #c8f53e;
      --accent-dim: #8aab1f;
      --text: #f0f0ee;
      --muted: #6b6b72;
      --bubble-user: #1e1e22;
      --bubble-server: #191d10;
      --radius: 16px;
    }

    body {
      font-family: 'DM Mono', monospace;
      background: var(--bg);
      color: var(--text);
      height: 100dvh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    /* Animated background grid */
    body::before {
      content: '';
      position: fixed;
      inset: 0;
      background-image:
        linear-gradient(rgba(200,245,62,0.03) 1px, transparent 1px),
        linear-gradient(90deg, rgba(200,245,62,0.03) 1px, transparent 1px);
      background-size: 40px 40px;
      pointer-events: none;
      z-index: 0;
    }

    .app {
      position: relative;
      z-index: 1;
      width: 100%;
      max-width: 680px;
      height: min(720px, 90dvh);
      display: flex;
      flex-direction: column;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      background: var(--surface);
      box-shadow: 0 0 0 1px rgba(200,245,62,0.05), 0 40px 80px rgba(0,0,0,0.6);
      overflow: hidden;
      animation: rise 0.5s cubic-bezier(0.16,1,0.3,1) both;
    }

    @keyframes rise {
      from { opacity: 0; transform: translateY(24px); }
      to   { opacity: 1; transform: translateY(0); }
    }

    /* Header */
    header {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 18px 24px;
      border-bottom: 1px solid var(--border);
      flex-shrink: 0;
    }

    .logo {
      width: 32px;
      height: 32px;
      background: var(--accent);
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .logo svg { width: 18px; height: 18px; fill: #0d0d0f; }

    .title {
      font-family: 'Syne', sans-serif;
      font-weight: 800;
      font-size: 1.1rem;
      letter-spacing: -0.02em;
    }

    .title span { color: var(--accent); }

    .status {
      margin-left: auto;
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 0.7rem;
      color: var(--muted);
    }

    .dot {
      width: 7px;
      height: 7px;
      border-radius: 50%;
      background: var(--accent);
      animation: pulse 2s ease infinite;
    }

    .dot.error { background: #ff4d4d; animation: none; }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.3; }
    }

    /* Messages */
    .messages {
      flex: 1;
      overflow-y: auto;
      padding: 20px 24px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      scroll-behavior: smooth;
    }

    .messages::-webkit-scrollbar { width: 4px; }
    .messages::-webkit-scrollbar-track { background: transparent; }
    .messages::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }

    .empty {
      margin: auto;
      text-align: center;
      color: var(--muted);
      font-size: 0.8rem;
      line-height: 2;
    }

    .empty .big {
      font-family: 'Syne', sans-serif;
      font-size: 2rem;
      font-weight: 800;
      color: var(--border);
      display: block;
      letter-spacing: -0.04em;
    }

    .bubble {
      max-width: 75%;
      padding: 10px 14px;
      border-radius: 12px;
      font-size: 0.82rem;
      line-height: 1.6;
      border: 1px solid var(--border);
      background: var(--bubble-user);
      align-self: flex-end;
      animation: pop 0.25s cubic-bezier(0.16,1,0.3,1) both;
      word-break: break-word;
    }

    .bubble.server {
      background: var(--bubble-server);
      align-self: flex-start;
      border-left: 2px solid var(--accent);
    }

    @keyframes pop {
      from { opacity: 0; transform: scale(0.92) translateY(8px); }
      to   { opacity: 1; transform: scale(1) translateY(0); }
    }

    .bubble-meta {
      font-size: 0.65rem;
      color: var(--muted);
      margin-top: 4px;
      text-align: right;
    }

    .bubble.server .bubble-meta { text-align: left; }

    /* Composer */
    .composer {
      padding: 16px 24px;
      border-top: 1px solid var(--border);
      display: flex;
      gap: 10px;
      flex-shrink: 0;
    }

    textarea {
      flex: 1;
      background: #0d0d0f;
      border: 1px solid var(--border);
      border-radius: 10px;
      color: var(--text);
      font-family: 'DM Mono', monospace;
      font-size: 0.82rem;
      padding: 10px 14px;
      resize: none;
      outline: none;
      line-height: 1.5;
      max-height: 120px;
      transition: border-color 0.2s;
    }

    textarea::placeholder { color: var(--muted); }

    textarea:focus { border-color: var(--accent); }

    button {
      background: var(--accent);
      border: none;
      border-radius: 10px;
      width: 42px;
      height: 42px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      align-self: flex-end;
      transition: transform 0.15s, background 0.15s;
    }

    button:hover { background: #d9ff5a; transform: scale(1.05); }
    button:active { transform: scale(0.95); }
    button:disabled { background: var(--border); cursor: not-allowed; transform: none; }
    button svg { width: 18px; height: 18px; fill: #0d0d0f; }

    /* Toast */
    .toast {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%) translateY(8px);
      background: #ff4d4d22;
      border: 1px solid #ff4d4d55;
      color: #ff7070;
      padding: 8px 16px;
      border-radius: 8px;
      font-size: 0.75rem;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s, transform 0.3s;
      z-index: 999;
    }
    .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }
  </style>
</head>
<body>

<div class="app">
  <header>
    <div class="logo">
      <svg viewBox="0 0 24 24"><path d="M20 2H4a2 2 0 00-2 2v14a2 2 0 002 2h4l4 4 4-4h4a2 2 0 002-2V4a2 2 0 00-2-2z"/></svg>
    </div>
    <div class="title">Poki<span>Chat</span></div>
    <div class="status">
      <div class="dot" id="dot"></div>
      <span id="status-text">connected</span>
    </div>
  </header>

  <div class="messages" id="messages">
    <div class="empty" id="empty">
      <span class="big">say something.</span>
      no messages yet
    </div>
  </div>

  <div class="composer">
    <textarea id="input" rows="1" placeholder="type a messageâ€¦"></textarea>
    <button id="send-btn" title="Send">
      <svg viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
    </button>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
  const API = 'http://localhost:8080/chat';
  const messagesEl = document.getElementById('messages');
  const inputEl    = document.getElementById('input');
  const sendBtn    = document.getElementById('send-btn');
  const dotEl      = document.getElementById('dot');
  const statusEl   = document.getElementById('status-text');
  const emptyEl    = document.getElementById('empty');
  const toastEl    = document.getElementById('toast');

  let known = new Set(); // track messages by index to avoid duplicates

  function showToast(msg) {
    toastEl.textContent = msg;
    toastEl.classList.add('show');
    setTimeout(() => toastEl.classList.remove('show'), 3000);
  }

  function setStatus(ok) {
    dotEl.className = 'dot' + (ok ? '' : ' error');
    statusEl.textContent = ok ? 'connected' : 'server offline';
  }

  function timeStr() {
    return new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
  }

  function addBubble(content, isServer = false, time = timeStr()) {
    emptyEl && (emptyEl.style.display = 'none');
    const wrap = document.createElement('div');
    wrap.innerHTML = `
      <div class="bubble${isServer ? ' server' : ''}">
        ${escHtml(content)}
        <div class="bubble-meta">${isServer ? 'ðŸ“¡ server Â· ' : ''}${time}</div>
      </div>`;
    messagesEl.appendChild(wrap.firstElementChild);
    messagesEl.scrollTop = messagesEl.scrollHeight;
  }

  function escHtml(s) {
    return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
  }

  async function fetchMessages() {
    try {
      const res = await fetch(API);
      if (!res.ok) throw new Error();
      const msgs = await res.json();
      setStatus(true);
      msgs.forEach((m, i) => {
        if (!known.has(i)) {
          known.add(i);
          addBubble(m.content, true);
        }
      });
    } catch {
      setStatus(false);
    }
  }

  async function sendMessage() {
    const text = inputEl.value.trim();
    if (!text) return;

    inputEl.value = '';
    inputEl.style.height = 'auto';
    sendBtn.disabled = true;

    // optimistic render
    addBubble(text, false);

    try {
      const res = await fetch(API, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ content: text })
      });
      if (!res.ok) throw new Error('send failed');
      setStatus(true);
      // refresh to sync
      setTimeout(fetchMessages, 200);
    } catch (e) {
      showToast('âš  failed to send â€” is the server running?');
      setStatus(false);
    } finally {
      sendBtn.disabled = false;
    }
  }

  // Auto-resize textarea
  inputEl.addEventListener('input', () => {
    inputEl.style.height = 'auto';
    inputEl.style.height = Math.min(inputEl.scrollHeight, 120) + 'px';
  });

  inputEl.addEventListener('keydown', e => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      sendMessage();
    }
  });

  sendBtn.addEventListener('click', sendMessage);

  // Poll for new messages every 2s
  fetchMessages();
  setInterval(fetchMessages, 2000);
</script>
</body>
</html>
