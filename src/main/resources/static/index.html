<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>PokiChat</title>
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;500;600;700;800&display=swap" rel="stylesheet"/>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg-darkest:    #0b0914;
      --sidebar-bg:    #110e1c;
      --chat-bg:       #17122a;
      --input-bg:      #211a35;
      --elevated:      #2a2040;
      --hover:         #1e1830;
      --border:        #2a2040;

      --purple-bright: #9b72f5;
      --purple-mid:    #7c5cbf;
      --purple-dim:    #4e3880;
      --purple-glow:   rgba(155,114,245,0.12);

      --text-primary:  #e8e0f5;
      --text-secondary:#a89cc8;
      --text-muted:    #5e4d7a;

      --online: #3ba55d;
      --radius: 4px;
    }

    html, body { height: 100%; font-family: 'Nunito', sans-serif; background: var(--bg-darkest); color: var(--text-primary); overflow: hidden; }

    .app { display: flex; height: 100dvh; animation: fadeIn 0.35s ease both; }
    @keyframes fadeIn { from { opacity: 0 } to { opacity: 1 } }

    /* â”€â”€ Server icons â”€â”€ */
    .servers {
      width: 72px;
      background: var(--bg-darkest);
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 12px 0;
      gap: 8px;
      flex-shrink: 0;
    }

    .srv-icon {
      width: 48px; height: 48px;
      border-radius: 50%;
      background: var(--sidebar-bg);
      display: flex; align-items: center; justify-content: center;
      cursor: pointer;
      font-weight: 800; font-size: 0.85rem;
      color: var(--text-secondary);
      position: relative;
      transition: border-radius 0.2s, background 0.2s;
    }
    .srv-icon.active { border-radius: 16px; background: var(--purple-bright); color: white; }
    .srv-icon:not(.active):hover { border-radius: 16px; background: var(--purple-mid); color: white; }
    .srv-icon svg { width: 22px; height: 22px; fill: currentColor; }

    .srv-pip {
      position: absolute; left: -12px;
      width: 4px; border-radius: 0 4px 4px 0;
      background: white; transition: height 0.18s;
      height: 0; top: 50%; transform: translateY(-50%);
    }
    .srv-icon.active .srv-pip { height: 40px; }
    .srv-icon:hover .srv-pip { height: 20px; }

    .srv-sep { width: 32px; height: 2px; background: var(--border); border-radius: 1px; margin: 2px 0; }

    /* â”€â”€ Channel sidebar â”€â”€ */
    .sidebar {
      width: 240px;
      background: var(--sidebar-bg);
      display: flex; flex-direction: column;
      flex-shrink: 0;
      border-right: 1px solid var(--border);
    }

    .srv-name {
      padding: 16px;
      font-weight: 700; font-size: 0.95rem;
      border-bottom: 1px solid var(--border);
      display: flex; align-items: center; justify-content: space-between;
      cursor: pointer;
      transition: background 0.15s;
    }
    .srv-name:hover { background: var(--hover); }
    .srv-name svg { width: 16px; height: 16px; fill: var(--text-muted); }

    .ch-section { padding: 16px 8px 0; flex: 1; }

    .ch-label {
      font-size: 0.68rem; font-weight: 700;
      letter-spacing: 0.07em; text-transform: uppercase;
      color: var(--text-muted); padding: 0 8px 6px;
      display: flex; align-items: center; gap: 4px;
      cursor: pointer;
    }
    .ch-label:hover { color: var(--text-secondary); }

    .channel {
      display: flex; align-items: center; gap: 8px;
      padding: 5px 8px; border-radius: var(--radius);
      cursor: pointer; color: var(--text-muted);
      font-size: 0.88rem; font-weight: 600;
      transition: background 0.1s, color 0.1s;
      margin-bottom: 1px;
    }
    .channel:hover { background: var(--hover); color: var(--text-secondary); }
    .channel.active { background: rgba(155,114,245,0.12); color: var(--text-primary); }
    .channel svg { width: 18px; height: 18px; fill: currentColor; flex-shrink: 0; }

    .badge { margin-left: auto; background: var(--purple-bright); color: white; font-size: 0.65rem; font-weight: 700; padding: 1px 5px; border-radius: 10px; }

    /* user panel */
    .user-panel {
      display: flex; align-items: center; gap: 8px;
      padding: 10px 12px;
      background: var(--bg-darkest);
      border-top: 1px solid var(--border);
    }
    .av {
      width: 32px; height: 32px; border-radius: 50%;
      background: var(--purple-dim);
      display: flex; align-items: center; justify-content: center;
      font-weight: 700; font-size: 0.78rem;
      flex-shrink: 0; position: relative;
    }
    .av::after {
      content: ''; position: absolute; bottom: -1px; right: -1px;
      width: 10px; height: 10px; background: var(--online);
      border-radius: 50%; border: 2px solid var(--bg-darkest);
    }
    .u-info { flex: 1; min-width: 0; }
    .u-name { font-size: 0.82rem; font-weight: 700; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .u-tag  { font-size: 0.68rem; color: var(--text-muted); }
    .u-actions { display: flex; gap: 2px; }
    .ib {
      width: 28px; height: 28px; border-radius: var(--radius);
      background: none; border: none; cursor: pointer;
      color: var(--text-muted);
      display: flex; align-items: center; justify-content: center;
      transition: background 0.12s, color 0.12s;
    }
    .ib:hover { background: var(--hover); color: var(--text-primary); }
    .ib svg { width: 16px; height: 16px; fill: currentColor; }

    /* â”€â”€ Chat â”€â”€ */
    .chat { flex: 1; display: flex; flex-direction: column; background: var(--chat-bg); min-width: 0; }

    .chat-hdr {
      display: flex; align-items: center; gap: 10px;
      padding: 12px 16px;
      border-bottom: 1px solid var(--border);
      flex-shrink: 0;
      box-shadow: 0 2px 8px rgba(0,0,0,0.25);
      z-index: 10;
    }
    .ch-hash { color: var(--text-muted); font-size: 1.25rem; font-weight: 900; }
    .ch-name { font-weight: 700; font-size: 0.95rem; }
    .hdr-sep { width: 1px; height: 20px; background: var(--border); margin: 0 4px; }
    .ch-topic { font-size: 0.78rem; color: var(--text-muted); }
    .hdr-right { margin-left: auto; display: flex; gap: 2px; }

    /* messages */
    .messages {
      flex: 1; overflow-y: auto;
      padding: 8px 0;
      display: flex; flex-direction: column;
    }
    .messages::-webkit-scrollbar { width: 6px; }
    .messages::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
    .messages::-webkit-scrollbar-thumb:hover { background: var(--purple-dim); }

    .welcome-wrap { padding: 24px 16px 12px; }
    .welcome-ico {
      width: 64px; height: 64px; border-radius: 50%;
      background: var(--elevated);
      display: flex; align-items: center; justify-content: center; margin-bottom: 14px;
    }
    .welcome-ico svg { width: 34px; height: 34px; fill: var(--purple-bright); }
    .welcome-wrap h2 { font-size: 1.35rem; font-weight: 800; margin-bottom: 6px; }
    .welcome-wrap p { font-size: 0.85rem; color: var(--text-secondary); line-height: 1.6; }

    .w-div { height: 1px; background: var(--border); margin: 12px 16px; }

    /* message group */
    .msg-group {
      padding: 2px 16px;
      display: flex; gap: 16px;
      border-radius: 2px;
      position: relative;
      transition: background 0.1s;
    }
    .msg-group:hover { background: rgba(0,0,0,0.12); }
    .msg-group:hover .msg-acts { opacity: 1; }
    .msg-group:hover .msg-side-ts { opacity: 1; }
    .msg-group.first { padding-top: 12px; }

    .msg-av {
      width: 40px; height: 40px; border-radius: 50%;
      flex-shrink: 0;
      display: flex; align-items: center; justify-content: center;
      font-weight: 700; font-size: 0.8rem;
      margin-top: 1px; cursor: pointer;
    }
    .msg-av.blank { background: transparent; }

    .msg-body { flex: 1; min-width: 0; }

    .msg-hdr { display: flex; align-items: baseline; gap: 8px; margin-bottom: 2px; }
    .msg-author { font-weight: 700; font-size: 0.9rem; cursor: pointer; }
    .msg-author:hover { text-decoration: underline; }
    .msg-author.you  { color: var(--purple-bright); }
    .msg-author.srv  { color: #89b4fa; }
    .bot-tag {
      font-size: 0.6rem; font-weight: 700;
      background: #5b84f5; color: white;
      padding: 1px 4px; border-radius: 3px; letter-spacing: 0.03em;
    }
    .msg-ts { font-size: 0.68rem; color: var(--text-muted); }
    .msg-side-ts {
      position: absolute; left: 22px;
      font-size: 0.65rem; color: var(--text-muted);
      opacity: 0; pointer-events: none;
      top: 50%; transform: translateY(-50%);
      transition: opacity 0.12s;
    }
    .msg-group.first .msg-side-ts { display: none; }

    .msg-content {
      font-size: 0.9rem; line-height: 1.55;
      color: var(--text-primary); word-break: break-word;
      animation: msgIn 0.2s cubic-bezier(0.16,1,0.3,1) both;
    }
    @keyframes msgIn { from { opacity:0; transform:translateY(4px); } to { opacity:1; transform:translateY(0); } }

    .msg-acts {
      position: absolute; right: 12px; top: -14px;
      background: var(--elevated); border: 1px solid var(--border);
      border-radius: 8px; display: flex; gap: 1px;
      padding: 3px 4px; opacity: 0; transition: opacity 0.12s;
      box-shadow: 0 4px 12px rgba(0,0,0,0.4); z-index: 5;
    }
    .mac { width: 26px; height: 26px; border-radius: var(--radius); background: none; border: none; cursor: pointer; color: var(--text-muted); display: flex; align-items: center; justify-content: center; font-size: 0.82rem; transition: background 0.1s, color 0.1s; }
    .mac:hover { background: var(--hover); color: var(--text-primary); }
    .mac svg { width: 14px; height: 14px; fill: currentColor; }

    /* typing */
    .typing-row { height: 20px; padding: 0 16px 4px; display: flex; align-items: center; gap: 6px; font-size: 0.72rem; color: var(--text-muted); flex-shrink: 0; }
    .tdots span { display: inline-block; width: 4px; height: 4px; background: var(--text-muted); border-radius: 50%; animation: tb 1.2s ease infinite; }
    .tdots span:nth-child(2) { animation-delay: 0.2s; }
    .tdots span:nth-child(3) { animation-delay: 0.4s; }
    @keyframes tb { 0%,80%,100%{transform:translateY(0);opacity:.4;} 40%{transform:translateY(-4px);opacity:1;} }

    /* input */
    .input-wrap { padding: 0 16px 20px; flex-shrink: 0; }
    .input-box {
      display: flex; align-items: flex-end;
      background: var(--input-bg); border-radius: 8px;
      border: 1px solid transparent;
      transition: border-color 0.2s;
      overflow: hidden;
    }
    .input-box:focus-within { border-color: var(--purple-dim); }
    .ipfx { display: flex; gap: 1px; padding: 9px 6px 9px 12px; align-self: flex-end; }
    textarea#msg {
      flex: 1; background: none; border: none; outline: none;
      resize: none; font-family: 'Nunito', sans-serif;
      font-size: 0.88rem; color: var(--text-primary);
      padding: 10px 4px; line-height: 1.5; max-height: 200px;
    }
    textarea#msg::placeholder { color: var(--text-muted); }
    .ipsfx { display: flex; gap: 2px; padding: 9px 12px 9px 6px; align-self: flex-end; }

    .send-btn {
      width: 32px; height: 32px; border-radius: var(--radius);
      background: var(--purple-bright); border: none; cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      transition: background 0.15s, transform 0.12s;
    }
    .send-btn:hover { background: #b08fff; transform: scale(1.06); }
    .send-btn:active { transform: scale(0.93); }
    .send-btn:disabled { background: var(--purple-dim); cursor: not-allowed; transform: none; }
    .send-btn svg { width: 16px; height: 16px; fill: white; }

    /* members sidebar */
    .members {
      width: 240px; background: var(--sidebar-bg);
      border-left: 1px solid var(--border);
      padding: 16px 8px; overflow-y: auto; flex-shrink: 0;
    }
    .mem-label { font-size: 0.68rem; font-weight: 700; letter-spacing: 0.08em; text-transform: uppercase; color: var(--text-muted); padding: 0 8px 8px; }
    .member { display: flex; align-items: center; gap: 10px; padding: 5px 8px; border-radius: var(--radius); cursor: pointer; transition: background 0.1s; margin-bottom: 1px; }
    .member:hover { background: var(--hover); }
    .mem-av { width: 32px; height: 32px; border-radius: 50%; background: var(--purple-dim); flex-shrink: 0; display: flex; align-items: center; justify-content: center; font-size: 0.72rem; font-weight: 700; position: relative; }
    .mem-av.online::after { content:''; position:absolute; bottom:-1px; right:-1px; width:10px; height:10px; background:var(--online); border-radius:50%; border:2px solid var(--sidebar-bg); }
    .mem-name { font-size: 0.85rem; font-weight: 600; color: var(--text-secondary); }
    .mem-name.you { color: var(--text-primary); }

    /* toast */
    .toast { position:fixed; bottom:20px; left:50%; transform:translateX(-50%) translateY(12px); background:#1e1630; border:1px solid var(--purple-dim); color:var(--text-primary); padding:10px 18px; border-radius:8px; font-size:0.8rem; font-weight:600; opacity:0; pointer-events:none; transition:opacity 0.25s,transform 0.25s; z-index:9999; box-shadow:0 8px 24px rgba(0,0,0,.5); }
    .toast.show { opacity:1; transform:translateX(-50%) translateY(0); }

    @media (max-width: 900px) { .members { display: none; } }
    @media (max-width: 640px) { .servers { display: none; } .sidebar { width: 200px; } }
  </style>
</head>
<body>
<div class="app">

  <!-- Server icons -->
  <nav class="servers">
    <div class="srv-icon active">
      <div class="srv-pip"></div>
      <svg viewBox="0 0 24 24"><path d="M20 2H4a2 2 0 00-2 2v14a2 2 0 002 2h4l4 4 4-4h4a2 2 0 002-2V4a2 2 0 00-2-2z"/></svg>
    </div>
    <div class="srv-sep"></div>
    <div class="srv-icon" style="font-size:1.3rem;color:var(--online);">
      <div class="srv-pip"></div>+
    </div>
  </nav>

  <!-- Channel list -->
  <aside class="sidebar">
    <div class="srv-name">
      PokiChat
      <svg viewBox="0 0 24 24"><path d="M7 10l5 5 5-5z"/></svg>
    </div>
    <div class="ch-section">
      <div class="ch-label">
        <svg width="10" height="10" viewBox="0 0 24 24" fill="currentColor"><path d="M7 10l5 5 5-5z"/></svg>
        Text Channels
      </div>
      <div class="channel active">
        <svg viewBox="0 0 24 24"><text x="2" y="17" font-size="16" font-weight="900" fill="currentColor">#</text></svg>
        general
      </div>
      <div class="channel">
        <svg viewBox="0 0 24 24"><text x="2" y="17" font-size="16" font-weight="900" fill="currentColor">#</text></svg>
        off-topic
      </div>
      <div class="channel">
        <svg viewBox="0 0 24 24"><text x="2" y="17" font-size="16" font-weight="900" fill="currentColor">#</text></svg>
        announcements
        <span class="badge">2</span>
      </div>
    </div>
    <div class="user-panel">
      <div class="av" id="my-av">?</div>
      <div class="u-info">
        <div class="u-name" id="my-name">You</div>
        <div class="u-tag">#0001</div>
      </div>
      <div class="u-actions">
        <button class="ib" title="Mute">
          <svg viewBox="0 0 24 24"><path d="M12 14a3 3 0 003-3V5a3 3 0 00-6 0v6a3 3 0 003 3zm5-3a5 5 0 01-10 0H5a7 7 0 0014 0h-2z"/></svg>
        </button>
        <button class="ib" title="Settings">
          <svg viewBox="0 0 24 24"><path d="M19.14 12.94c.04-.3.06-.61.06-.94s-.02-.64-.07-.94l2.03-1.58c.19-.14.23-.41.12-.61l-1.92-3.32a.49.49 0 00-.59-.22l-2.39.96a7.04 7.04 0 00-1.62-.94l-.36-2.54A.49.49 0 0014 3h-4a.49.49 0 00-.47.41l-.36 2.54a7.04 7.04 0 00-1.62.94l-2.39-.96a.49.49 0 00-.59.22L2.65 9.47a.48.48 0 00.12.61l2.03 1.58c-.05.3-.09.63-.09.94s.02.64.07.94L2.74 15.12a.49.49 0 00.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32a.49.49 0 00-.12-.61l-2.01-1.58zM12 15.6a3.6 3.6 0 110-7.2 3.6 3.6 0 010 7.2z"/></svg>
        </button>
      </div>
    </div>
  </aside>

  <!-- Main chat -->
  <main class="chat">
    <div class="chat-hdr">
      <span class="ch-hash">#</span>
      <span class="ch-name">general</span>
      <div class="hdr-sep"></div>
      <span class="ch-topic">The main chat â€” say something! ðŸ”®</span>
      <div class="hdr-right">
        <button class="ib" title="Members">
          <svg viewBox="0 0 24 24"><path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z"/></svg>
        </button>
        <button class="ib" title="Search">
          <svg viewBox="0 0 24 24"><path d="M15.5 14h-.79l-.28-.27A6.47 6.47 0 0016 9.5 6.5 6.5 0 109.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>
        </button>
      </div>
    </div>

    <div class="messages" id="messages">
      <div class="welcome-wrap">
        <div class="welcome-ico">
          <svg viewBox="0 0 24 24"><path d="M20 2H4a2 2 0 00-2 2v14a2 2 0 002 2h4l4 4 4-4h4a2 2 0 002-2V4a2 2 0 00-2-2z"/></svg>
        </div>
        <h2>Welcome to #general!</h2>
        <p>This is the beginning of the #general channel. Say hi ðŸ‘‹</p>
      </div>
      <div class="w-div"></div>
    </div>

    <div class="typing-row" id="typing-row" style="visibility:hidden;">
      <div class="tdots"><span></span><span></span><span></span></div>
      <span id="typing-txt">loading...</span>
    </div>

    <div class="input-wrap">
      <div class="input-box">
        <div class="ipfx">
          <button class="ib" title="Upload">
            <svg viewBox="0 0 24 24"><path d="M12 2a10 10 0 100 20A10 10 0 0012 2zm5 11h-4v4h-2v-4H7v-2h4V7h2v4h4v2z"/></svg>
          </button>
        </div>
        <textarea id="msg" rows="1" placeholder="Message #general"></textarea>
        <div class="ipsfx">
          <button class="ib" title="Emoji">ðŸ˜„</button>
          <button class="send-btn" id="send-btn" title="Send">
            <svg viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
          </button>
        </div>
      </div>
    </div>
  </main>

  <!-- Members -->
  <aside class="members">
    <div class="mem-label">Online â€” 1</div>
    <div class="member">
      <div class="mem-av online" id="mem-av">?</div>
      <div class="mem-name you" id="mem-nm">You</div>
    </div>
    <div style="height:10px;"></div>
    <div class="mem-label">Offline â€” 0</div>
  </aside>
</div>

<div class="toast" id="toast"></div>

<script>
  const API = 'chat';
  const msgsEl   = document.getElementById('messages');
  const inputEl  = document.getElementById('msg');
  const sendBtn  = document.getElementById('send-btn');
  const toastEl  = document.getElementById('toast');

  /* â”€â”€ Username â”€â”€ */
  let username = '';
  try { username = localStorage.getItem('pokichat_name') || ''; } catch(e) {}
  if (!username) {
    username = prompt('What should we call you in the chat?', 'Guest') || 'Guest';
    try { localStorage.setItem('pokichat_name', username); } catch(e) {}
  }
  const initials = username.slice(0, 2).toUpperCase();
  document.getElementById('my-av').textContent   = initials;
  document.getElementById('my-name').textContent = username;
  document.getElementById('mem-av').textContent  = initials;
  document.getElementById('mem-nm').textContent  = username;

  /* â”€â”€ Helpers â”€â”€ */
  function esc(s) {
    return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
  }
  function ts(d = new Date()) {
    return d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
  }
  function showToast(m) {
    toastEl.textContent = m;
    toastEl.classList.add('show');
    setTimeout(() => toastEl.classList.remove('show'), 3000);
  }
  function avatarColor(name) {
    const hue = [...name].reduce((a,c) => a + c.charCodeAt(0), 0) % 360;
    return `hsl(${hue},40%,30%)`;
  }

  /* â”€â”€ Render â”€â”€ */
  let lastAuthor = null;
  let knownCount = 0;

  function addMsg(content, author, isServer = false, time = ts()) {
    const isFirst = author !== lastAuthor;
    lastAuthor = author;

    const g = document.createElement('div');
    g.className = 'msg-group' + (isFirst ? ' first' : '');

    // Side timestamp for continuation messages
    if (!isFirst) {
      const sts = document.createElement('span');
      sts.className = 'msg-side-ts';
      sts.textContent = time;
      g.appendChild(sts);
    }

    // Avatar
    const av = document.createElement('div');
    if (isFirst) {
      av.className = 'msg-av';
      av.textContent = author.slice(0,2).toUpperCase();
      av.style.background = (author === username) ? 'var(--purple-dim)' : avatarColor(author);
    } else {
      av.className = 'msg-av blank';
    }

    // Body
    const body = document.createElement('div');
    body.className = 'msg-body';

    if (isFirst) {
      const authorCls = author === username ? 'you' : (isServer ? 'srv' : '');
      const badge = isServer ? '<span class="bot-tag">SERVER</span>' : '';
      body.innerHTML = `<div class="msg-hdr">
        <span class="msg-author ${authorCls}">${esc(author)}</span>
        ${badge}
        <span class="msg-ts">Today at ${time}</span>
      </div>`;
    }

    const c = document.createElement('div');
    c.className = 'msg-content';
    c.textContent = content;
    body.appendChild(c);

    // Hover actions
    const acts = document.createElement('div');
    acts.className = 'msg-acts';
    acts.innerHTML = `
      <button class="mac" title="React">ðŸ˜„</button>
      <button class="mac" title="Reply">
        <svg viewBox="0 0 24 24"><path d="M10 9V5l-7 7 7 7v-4.1c5 0 8.5 1.6 11 5.1-1-5-4-10-11-11z"/></svg>
      </button>
      <button class="mac" title="More">â‹¯</button>`;
    g.appendChild(acts);

    g.appendChild(av);
    g.appendChild(body);
    msgsEl.appendChild(g);
    msgsEl.scrollTop = msgsEl.scrollHeight;
  }

  /* â”€â”€ Send â”€â”€ */
  async function send() {
    const text = inputEl.value.trim();
    if (!text) return;
    inputEl.value = '';
    inputEl.style.height = 'auto';
    sendBtn.disabled = true;

    // Optimistic render
    addMsg(text, username, false);
    knownCount++;

    try {
      const r = await fetch(API, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ user: username, content: text })
      });
      if (!r.ok) throw new Error();
    } catch {
      showToast('âš  Failed to send â€” is the server running?');
      knownCount--;
    } finally {
      sendBtn.disabled = false;
      inputEl.focus();
    }
  }

  /* â”€â”€ Poll â”€â”€ */
  async function poll() {
    try {
      const r = await fetch(API);
      if (!r.ok) return;
      const msgs = await r.json();
      if (msgs.length > knownCount) {
        for (let i = knownCount; i < msgs.length; i++) {
          const m = msgs[i];
          const author = (m.user && m.user.trim()) ? m.user : 'Unknown';
          // Skip our own messages â€” already rendered optimistically
          if (author !== username) {
            addMsg(m.content, author, false);
          }
        }
        knownCount = msgs.length;
      }
    } catch { /* server offline */ }
  }

  /* â”€â”€ Events â”€â”€ */
  inputEl.addEventListener('input', () => {
    inputEl.style.height = 'auto';
    inputEl.style.height = Math.min(inputEl.scrollHeight, 200) + 'px';
  });
  inputEl.addEventListener('keydown', e => {
    if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); send(); }
  });
  sendBtn.addEventListener('click', send);

  poll();
  setInterval(poll, 2000);
</script>
</body>
</html>
