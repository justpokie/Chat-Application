<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>PokiChat</title>
  <link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=DM+Sans:wght@300;400;500&display=swap" rel="stylesheet"/>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.6.1/sockjs.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg-void: #0a0a0c;
      --bg-base: #0f0f12;
      --bg-surface: #141418;
      --bg-elevated: #1a1a20;
      --bg-hover: #1f1f28;
      --border: #2a2a35;
      --border-bright: #3a3a48;
      --text-primary: #e8e8f0;
      --text-secondary: #8888a0;
      --text-muted: #555568;
      --accent: #8b5cf6;
      --accent-bright: #a78bfa;
      --accent-dim: #4c2d8f;
      --accent-glow: rgba(139, 92, 246, 0.15);
      --accent-glow-strong: rgba(139, 92, 246, 0.3);
      --online: #5eead4;
      --sidebar-w: 240px;
    }

    html, body {
      height: 100%;
      background: var(--bg-void);
      color: var(--text-primary);
      font-family: 'DM Sans', sans-serif;
      font-size: 14px;
      overflow: hidden;
    }

    /* NOISE TEXTURE OVERLAY */
    body::before {
      content: '';
      position: fixed;
      inset: 0;
      background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.03'/%3E%3C/svg%3E");
      pointer-events: none;
      z-index: 9999;
      opacity: 0.4;
    }

    /* LAYOUT */
    .app {
      display: flex;
      height: 100vh;
      width: 100vw;
    }

    /* â”€â”€â”€ SIDEBAR â”€â”€â”€ */
    .sidebar {
      width: var(--sidebar-w);
      background: var(--bg-base);
      border-right: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      flex-shrink: 0;
      position: relative;
    }

    .sidebar::after {
      content: '';
      position: absolute;
      top: 0; right: -1px;
      width: 1px; height: 100%;
      background: linear-gradient(to bottom, transparent, var(--accent-dim) 40%, var(--accent) 60%, transparent);
      opacity: 0.4;
    }

    .sidebar-header {
      padding: 20px 16px 16px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .logo-mark {
      width: 28px; height: 28px;
      background: var(--accent);
      border-radius: 6px;
      display: flex; align-items: center; justify-content: center;
      font-family: 'Space Mono', monospace;
      font-size: 11px;
      font-weight: 700;
      color: white;
      flex-shrink: 0;
      box-shadow: 0 0 12px var(--accent-glow-strong);
    }

    .app-name {
      font-family: 'Space Mono', monospace;
      font-size: 13px;
      font-weight: 700;
      letter-spacing: 0.05em;
      color: var(--text-primary);
    }

    .section-label {
      padding: 16px 16px 6px;
      font-size: 10px;
      font-family: 'Space Mono', monospace;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      color: var(--text-muted);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .create-channel-btn {
      width: 18px; height: 18px;
      background: transparent;
      border: 1px solid var(--border-bright);
      border-radius: 4px;
      color: var(--text-muted);
      cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      font-size: 14px;
      line-height: 1;
      transition: all 0.15s ease;
      padding-bottom: 1px;
    }
    .create-channel-btn:hover {
      background: var(--accent-glow);
      border-color: var(--accent);
      color: var(--accent-bright);
    }

    .channels-list {
      flex: 1;
      overflow-y: auto;
      padding: 4px 8px;
    }
    .channels-list::-webkit-scrollbar { width: 4px; }
    .channels-list::-webkit-scrollbar-track { background: transparent; }
    .channels-list::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

    .channel-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 7px 10px;
      border-radius: 6px;
      cursor: pointer;
      color: var(--text-secondary);
      transition: all 0.12s ease;
      margin-bottom: 1px;
      position: relative;
      border: 1px solid transparent;
    }
    .channel-item:hover {
      background: var(--bg-hover);
      color: var(--text-primary);
      border-color: var(--border);
    }
    .channel-item.active {
      background: var(--accent-glow);
      border-color: var(--accent-dim);
      color: var(--accent-bright);
    }
    .channel-item.active .channel-hash {
      color: var(--accent);
    }

    .channel-hash {
      font-family: 'Space Mono', monospace;
      font-size: 13px;
      color: var(--text-muted);
      transition: color 0.12s;
      flex-shrink: 0;
    }
    .channel-name {
      font-size: 13px;
      font-weight: 400;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .sidebar-footer {
      padding: 12px 16px;
      border-top: 1px solid var(--border);
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .user-avatar {
      width: 30px; height: 30px;
      border-radius: 50%;
      background: var(--bg-elevated);
      border: 1px solid var(--border-bright);
      display: flex; align-items: center; justify-content: center;
      font-size: 13px;
    }
    .user-name-input {
      flex: 1;
      background: transparent;
      border: none;
      outline: none;
      color: var(--text-secondary);
      font-family: 'DM Sans', sans-serif;
      font-size: 13px;
      cursor: pointer;
    }
    .user-name-input:focus {
      color: var(--text-primary);
    }

    /* â”€â”€â”€ MAIN AREA â”€â”€â”€ */
    .main {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: var(--bg-base);
      min-width: 0;
    }

    .chat-header {
      height: 52px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      padding: 0 20px;
      gap: 10px;
      flex-shrink: 0;
      background: var(--bg-surface);
    }

    .chat-header-hash {
      font-family: 'Space Mono', monospace;
      font-size: 18px;
      color: var(--accent);
    }

    .chat-header-name {
      font-family: 'Space Mono', monospace;
      font-size: 14px;
      font-weight: 700;
      letter-spacing: 0.03em;
    }

    .chat-header-divider {
      width: 1px; height: 18px;
      background: var(--border-bright);
      margin: 0 4px;
    }

    .chat-header-desc {
      font-size: 13px;
      color: var(--text-muted);
    }

    .connection-badge {
      margin-left: auto;
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 11px;
      font-family: 'Space Mono', monospace;
      color: var(--text-muted);
    }
    .connection-dot {
      width: 6px; height: 6px;
      border-radius: 50%;
      background: var(--text-muted);
      transition: all 0.3s ease;
    }
    .connection-dot.connected { background: var(--online); box-shadow: 0 0 6px var(--online); }
    .connection-dot.connecting { background: #f59e0b; animation: pulse 1s infinite; }

    /* â”€â”€â”€ MESSAGES â”€â”€â”€ */
    .messages-area {
      flex: 1;
      overflow-y: auto;
      padding: 20px 0;
      display: flex;
      flex-direction: column;
      gap: 0;
    }
    .messages-area::-webkit-scrollbar { width: 6px; }
    .messages-area::-webkit-scrollbar-track { background: transparent; }
    .messages-area::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

    .empty-state {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: var(--text-muted);
      gap: 12px;
      animation: fadeIn 0.3s ease;
    }
    .empty-icon {
      font-size: 40px;
      opacity: 0.3;
    }
    .empty-text {
      font-family: 'Space Mono', monospace;
      font-size: 12px;
      letter-spacing: 0.08em;
    }

    .no-channel-state {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 16px;
    }
    .no-channel-glyph {
      font-size: 64px;
      opacity: 0.08;
    }
    .no-channel-title {
      font-family: 'Space Mono', monospace;
      font-size: 15px;
      color: var(--text-secondary);
    }
    .no-channel-sub {
      font-size: 13px;
      color: var(--text-muted);
    }

    /* Message groups */
    .message-group {
      padding: 6px 20px;
      display: flex;
      gap: 12px;
      transition: background 0.1s;
      animation: slideIn 0.18s ease;
    }
    .message-group:hover { background: var(--bg-surface); }

    .message-avatar {
      width: 34px; height: 34px;
      border-radius: 8px;
      background: var(--bg-elevated);
      border: 1px solid var(--border);
      display: flex; align-items: center; justify-content: center;
      font-size: 14px;
      flex-shrink: 0;
      margin-top: 2px;
    }

    .message-body { flex: 1; min-width: 0; }

    .message-meta {
      display: flex;
      align-items: baseline;
      gap: 8px;
      margin-bottom: 3px;
    }
    .message-author {
      font-size: 13px;
      font-weight: 500;
      color: var(--accent-bright);
    }
    .message-author.is-self { color: var(--text-primary); }
    .message-time {
      font-size: 10px;
      font-family: 'Space Mono', monospace;
      color: var(--text-muted);
    }
    .message-content {
      font-size: 14px;
      line-height: 1.55;
      color: var(--text-primary);
      word-break: break-word;
    }

    .date-divider {
      display: flex;
      align-items: center;
      padding: 8px 20px;
      gap: 10px;
      margin: 4px 0;
    }
    .date-divider-line { flex: 1; height: 1px; background: var(--border); }
    .date-divider-text {
      font-size: 10px;
      font-family: 'Space Mono', monospace;
      color: var(--text-muted);
      letter-spacing: 0.08em;
      white-space: nowrap;
    }

    /* â”€â”€â”€ INPUT AREA â”€â”€â”€ */
    .input-area {
      padding: 12px 20px 16px;
      flex-shrink: 0;
    }

    .input-box {
      background: var(--bg-elevated);
      border: 1px solid var(--border);
      border-radius: 10px;
      display: flex;
      align-items: flex-end;
      gap: 0;
      transition: border-color 0.15s, box-shadow 0.15s;
      overflow: hidden;
    }
    .input-box:focus-within {
      border-color: var(--accent-dim);
      box-shadow: 0 0 0 2px var(--accent-glow);
    }

    .message-input {
      flex: 1;
      background: transparent;
      border: none;
      outline: none;
      color: var(--text-primary);
      font-family: 'DM Sans', sans-serif;
      font-size: 14px;
      padding: 12px 14px;
      resize: none;
      min-height: 44px;
      max-height: 120px;
      line-height: 1.5;
    }
    .message-input::placeholder { color: var(--text-muted); }

    .send-btn {
      margin: 6px;
      width: 32px; height: 32px;
      background: var(--accent);
      border: none;
      border-radius: 7px;
      color: white;
      cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      transition: all 0.15s ease;
      flex-shrink: 0;
    }
    .send-btn:hover { background: var(--accent-bright); transform: scale(1.05); }
    .send-btn:active { transform: scale(0.96); }
    .send-btn:disabled { background: var(--bg-hover); color: var(--text-muted); cursor: not-allowed; transform: none; }

    .send-icon { width: 14px; height: 14px; fill: none; stroke: currentColor; stroke-width: 2.2; stroke-linecap: round; stroke-linejoin: round; }

    /* â”€â”€â”€ MODAL â”€â”€â”€ */
    .modal-overlay {
      position: fixed; inset: 0;
      background: rgba(0,0,0,0.7);
      backdrop-filter: blur(4px);
      display: flex; align-items: center; justify-content: center;
      z-index: 1000;
      opacity: 0; pointer-events: none;
      transition: opacity 0.2s ease;
    }
    .modal-overlay.visible { opacity: 1; pointer-events: all; }

    .modal {
      background: var(--bg-elevated);
      border: 1px solid var(--border-bright);
      border-radius: 12px;
      padding: 28px;
      width: 340px;
      transform: translateY(8px) scale(0.98);
      transition: transform 0.2s ease;
      box-shadow: 0 20px 60px rgba(0,0,0,0.6), 0 0 0 1px rgba(139,92,246,0.1);
    }
    .modal-overlay.visible .modal { transform: none; }

    .modal-title {
      font-family: 'Space Mono', monospace;
      font-size: 14px;
      font-weight: 700;
      margin-bottom: 6px;
    }
    .modal-sub {
      font-size: 12px;
      color: var(--text-muted);
      margin-bottom: 20px;
    }

    .modal-input {
      width: 100%;
      background: var(--bg-surface);
      border: 1px solid var(--border-bright);
      border-radius: 8px;
      padding: 10px 12px;
      color: var(--text-primary);
      font-family: 'Space Mono', monospace;
      font-size: 13px;
      outline: none;
      transition: border-color 0.15s;
    }
    .modal-input:focus { border-color: var(--accent); box-shadow: 0 0 0 2px var(--accent-glow); }
    .modal-input::placeholder { color: var(--text-muted); }

    .modal-actions {
      display: flex;
      gap: 8px;
      margin-top: 16px;
      justify-content: flex-end;
    }

    .btn {
      padding: 8px 16px;
      border-radius: 7px;
      border: none;
      font-family: 'Space Mono', monospace;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.15s;
    }
    .btn-ghost {
      background: transparent;
      color: var(--text-secondary);
      border: 1px solid var(--border);
    }
    .btn-ghost:hover { background: var(--bg-hover); color: var(--text-primary); }
    .btn-primary {
      background: var(--accent);
      color: white;
    }
    .btn-primary:hover { background: var(--accent-bright); }

    /* â”€â”€â”€ TOAST â”€â”€â”€ */
    .toast-container {
      position: fixed;
      bottom: 24px; right: 24px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      z-index: 9000;
    }
    .toast {
      background: var(--bg-elevated);
      border: 1px solid var(--border-bright);
      border-radius: 8px;
      padding: 10px 14px;
      font-size: 12px;
      font-family: 'Space Mono', monospace;
      color: var(--text-secondary);
      animation: toastIn 0.2s ease, toastOut 0.2s ease 2.8s forwards;
      box-shadow: 0 8px 24px rgba(0,0,0,0.4);
    }
    .toast.error { border-color: #ef4444; color: #f87171; }
    .toast.success { border-color: var(--accent); color: var(--accent-bright); }

    @keyframes toastIn { from { transform: translateX(20px); opacity: 0; } to { transform: none; opacity: 1; } }
    @keyframes toastOut { from { opacity: 1; } to { opacity: 0; pointer-events: none; } }
    @keyframes slideIn { from { transform: translateY(4px); opacity: 0; } to { transform: none; opacity: 1; } }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }
  </style>
</head>
<body>

<div class="app">
  <!-- SIDEBAR -->
  <aside class="sidebar">
    <div class="sidebar-header">
      <div class="logo-mark">pk</div>
      <span class="app-name">pokichat</span>
    </div>

    <div class="section-label">
      channels
      <button class="create-channel-btn" id="openModal" title="New channel">+</button>
    </div>

    <div class="channels-list" id="channelsList">
      <!-- channels populated here -->
    </div>

    <div class="sidebar-footer">
      <div class="user-avatar" id="userAvatarEmoji">ðŸ‘¤</div>
      <input class="user-name-input" id="usernameInput" value="anon" placeholder="your name" maxlength="24" title="Click to change username"/>
    </div>
  </aside>

  <!-- MAIN -->
  <main class="main">
    <div class="chat-header">
      <span class="chat-header-hash" id="headerHash">#</span>
      <span class="chat-header-name" id="headerName">select a channel</span>
      <div class="chat-header-divider" id="headerDivider" style="display:none"></div>
      <span class="chat-header-desc" id="headerDesc"></span>
      <div class="connection-badge">
        <div class="connection-dot" id="connDot"></div>
        <span id="connLabel">offline</span>
      </div>
    </div>

    <div class="messages-area" id="messagesArea">
      <div class="no-channel-state">
        <div class="no-channel-glyph">â¬¡</div>
        <div class="no-channel-title">no channel selected</div>
        <div class="no-channel-sub">pick one from the sidebar or create a new one</div>
      </div>
    </div>

    <div class="input-area">
      <div class="input-box">
        <textarea class="message-input" id="messageInput" placeholder="select a channel to start chatting..." rows="1" disabled></textarea>
        <button class="send-btn" id="sendBtn" disabled>
          <svg class="send-icon" viewBox="0 0 24 24">
            <line x1="22" y1="2" x2="11" y2="13"/>
            <polygon points="22 2 15 22 11 13 2 9 22 2"/>
          </svg>
        </button>
      </div>
    </div>
  </main>
</div>

<!-- CREATE CHANNEL MODAL -->
<div class="modal-overlay" id="modalOverlay">
  <div class="modal">
    <div class="modal-title">create channel</div>
    <div class="modal-sub">lowercase letters, numbers, and hyphens only</div>
    <input class="modal-input" id="channelNameInput" placeholder="e.g. general" maxlength="32" autocomplete="off"/>
    <div class="modal-actions">
      <button class="btn btn-ghost" id="cancelModal">cancel</button>
      <button class="btn btn-primary" id="confirmCreate">create</button>
    </div>
  </div>
</div>

<!-- TOAST CONTAINER -->
<div class="toast-container" id="toastContainer"></div>

<script>
  const API_BASE = 'http://localhost:8080';
  let stompClient = null;
  let currentChannel = null;
  let subscription = null;
  const messagesByChannel = {};

  // Avatars cycle
  const avatars = ['ðŸˆ','ðŸ¦Š','ðŸ™','ðŸ¦‹','ðŸŒ‘','ðŸ”®','âš¡','ðŸŒ¿','ðŸ‘¾','ðŸš'];
  let avatarIndex = Math.floor(Math.random() * avatars.length);
  document.getElementById('userAvatarEmoji').textContent = avatars[avatarIndex];

  // â”€â”€â”€ USERNAME â”€â”€â”€
  const usernameInput = document.getElementById('usernameInput');
  usernameInput.addEventListener('dblclick', () => usernameInput.select());

  // â”€â”€â”€ CONNECTION â”€â”€â”€
  function setConnStatus(state) {
    const dot = document.getElementById('connDot');
    const lbl = document.getElementById('connLabel');
    dot.className = 'connection-dot ' + state;
    lbl.textContent = state;
  }

  function connectWS() {
    setConnStatus('connecting');
    try {
      const sock = new SockJS(`${API_BASE}/ws`);
      stompClient = Stomp.over(sock);
      stompClient.debug = () => {};
      stompClient.connect({}, () => {
        setConnStatus('connected');
        if (currentChannel) subscribeChannel(currentChannel);
      }, () => {
        setConnStatus('offline');
        setTimeout(connectWS, 4000);
      });
    } catch(e) {
      setConnStatus('offline');
      setTimeout(connectWS, 4000);
    }
  }

  function subscribeChannel(channel) {
    if (subscription) { subscription.unsubscribe(); subscription = null; }
    if (!stompClient || !stompClient.connected) return;
    subscription = stompClient.subscribe(`/chat/${channel.channel_id}`, (frame) => {
      const msg = JSON.parse(frame.body);
      appendMessage(msg, channel.channel_id);
    });
  }

  // â”€â”€â”€ CHANNELS â”€â”€â”€
  let channels = [];

  async function loadChannels() {
    try {
      const res = await fetch(`${API_BASE}/chat/get_channels`);
      if (!res.ok) throw new Error();
      channels = await res.json();
      renderChannels();
    } catch(e) {
      toast('could not load channels', 'error');
    }
  }

  function renderChannels() {
    const list = document.getElementById('channelsList');
    if (!channels.length) {
      list.innerHTML = `<div style="padding:8px 10px;font-size:11px;color:var(--text-muted);font-family:'Space Mono',monospace;">no channels yet</div>`;
      return;
    }
    list.innerHTML = channels.map(ch => `
      <div class="channel-item ${currentChannel?.channel_id === ch.channel_id ? 'active' : ''}"
           data-id="${ch.channel_id}" onclick="selectChannel(${ch.channel_id})">
        <span class="channel-hash">#</span>
        <span class="channel-name">${escHtml(ch.name)}</span>
      </div>
    `).join('');
  }

  function selectChannel(id) {
    const ch = channels.find(c => c.channel_id === id);
    if (!ch) return;
    currentChannel = ch;
    renderChannels();

    document.getElementById('headerHash').textContent = '#';
    document.getElementById('headerName').textContent = ch.name;
    document.getElementById('headerDivider').style.display = '';
    document.getElementById('headerDesc').textContent = `channel Â· id ${ch.channel_id}`;

    const input = document.getElementById('messageInput');
    const send = document.getElementById('sendBtn');
    input.placeholder = `message #${ch.name}`;
    input.disabled = false;
    send.disabled = false;
    input.focus();

    if (stompClient?.connected) subscribeChannel(ch);
    loadMessages(ch);
  }

  async function loadMessages(ch) {
    renderMessages(ch.channel_id);
    try {
      const res = await fetch(`${API_BASE}/chat/${ch.channel_id}`);
      if (!res.ok) throw new Error();
      const msgs = await res.json();
      // The API returns DESC, so reverse for chronological
      messagesByChannel[ch.channel_id] = msgs.reverse();
      if (currentChannel?.channel_id === ch.channel_id) renderMessages(ch.channel_id);
    } catch(e) {
      // no messages or server issue
    }
  }

  function renderMessages(channelId) {
    const area = document.getElementById('messagesArea');
    const msgs = messagesByChannel[channelId] || [];

    if (!msgs.length) {
      area.innerHTML = `<div class="empty-state"><div class="empty-icon">â¬¡</div><div class="empty-text">no messages yet â€” say something</div></div>`;
      return;
    }

    let html = '';
    let lastDate = null;
    const me = usernameInput.value.trim() || 'anon';

    msgs.forEach((m, i) => {
      const dt = m.dateCreated ? new Date(m.dateCreated) : null;
      const dateStr = dt ? dt.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }) : null;
      if (dateStr && dateStr !== lastDate) {
        html += `<div class="date-divider"><div class="date-divider-line"></div><div class="date-divider-text">${dateStr}</div><div class="date-divider-line"></div></div>`;
        lastDate = dateStr;
      }
      const timeStr = dt ? dt.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' }) : '';
      const author = m.user || 'anon';
      const isMe = author === me;
      const emoji = avatars[author.charCodeAt(0) % avatars.length];

      html += `<div class="message-group">
        <div class="message-avatar">${emoji}</div>
        <div class="message-body">
          <div class="message-meta">
            <span class="message-author ${isMe ? 'is-self' : ''}">${escHtml(author)}</span>
            <span class="message-time">${timeStr}</span>
          </div>
          <div class="message-content">${escHtml(m.content)}</div>
        </div>
      </div>`;
    });

    area.innerHTML = html;
    area.scrollTop = area.scrollHeight;
  }

  function buildMessageEl(msg) {
    const me = usernameInput.value.trim() || 'anon';
    const dt = msg.dateCreated ? new Date(msg.dateCreated) : new Date();
    const timeStr = dt.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
    const author = msg.user || 'anon';
    const isMe = author === me;
    const emoji = avatars[author.charCodeAt(0) % avatars.length];

    const el = document.createElement('div');
    el.className = 'message-group';
    el.innerHTML = `
      <div class="message-avatar">${emoji}</div>
      <div class="message-body">
        <div class="message-meta">
          <span class="message-author ${isMe ? 'is-self' : ''}">${escHtml(author)}</span>
          <span class="message-time">${timeStr}</span>
        </div>
        <div class="message-content">${escHtml(msg.content)}</div>
      </div>`;
    return el;
  }

  function appendMessage(msg, channelId) {
    if (!messagesByChannel[channelId]) messagesByChannel[channelId] = [];
    // Deduplicate by message_id
    const alreadyExists = msg.message_id && messagesByChannel[channelId].some(m => m.message_id === msg.message_id);
    if (alreadyExists) return;
    messagesByChannel[channelId].push(msg);

    if (currentChannel?.channel_id === channelId) {
      const area = document.getElementById('messagesArea');
      // Clear empty/no-channel placeholder if present
      if (area.querySelector('.empty-state, .no-channel-state')) area.innerHTML = '';
      const el = buildMessageEl(msg);
      area.appendChild(el);
      area.scrollTop = area.scrollHeight;
    }
  }

  // â”€â”€â”€ SEND MESSAGE â”€â”€â”€
  function sendMessage() {
    if (!currentChannel) return;
    const input = document.getElementById('messageInput');
    const content = input.value.trim();
    if (!content) return;

    const username = usernameInput.value.trim() || 'anon';

    if (!stompClient?.connected) {
      toast('not connected', 'error');
      return;
    }

    const payload = { user: username, content };
    stompClient.send(`/app/${currentChannel.channel_id}.sendMessage`, {}, JSON.stringify(payload));

    input.value = '';
    input.style.height = 'auto';
  }

  document.getElementById('sendBtn').addEventListener('click', sendMessage);
  document.getElementById('messageInput').addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      sendMessage();
    }
  });

  // auto-resize textarea
  document.getElementById('messageInput').addEventListener('input', function() {
    this.style.height = 'auto';
    this.style.height = Math.min(this.scrollHeight, 120) + 'px';
  });

  // â”€â”€â”€ CREATE CHANNEL MODAL â”€â”€â”€
  const overlay = document.getElementById('modalOverlay');
  const channelNameInput = document.getElementById('channelNameInput');

  document.getElementById('openModal').addEventListener('click', () => {
    overlay.classList.add('visible');
    channelNameInput.value = '';
    setTimeout(() => channelNameInput.focus(), 50);
  });

  document.getElementById('cancelModal').addEventListener('click', () => overlay.classList.remove('visible'));
  overlay.addEventListener('click', (e) => { if (e.target === overlay) overlay.classList.remove('visible'); });

  channelNameInput.addEventListener('input', () => {
    channelNameInput.value = channelNameInput.value.toLowerCase().replace(/[^a-z0-9-]/g, '');
  });
  channelNameInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') doCreateChannel(); });

  document.getElementById('confirmCreate').addEventListener('click', doCreateChannel);

  async function doCreateChannel() {
    const name = channelNameInput.value.trim();
    if (!name) { channelNameInput.focus(); return; }
    if (channels.find(c => c.name === name)) {
      toast('channel already exists', 'error');
      return;
    }

    try {
      const res = await fetch(`${API_BASE}/chat/create_channel/${encodeURIComponent(name)}`, { method: 'POST' });
      if (!res.ok) throw new Error();
      const newChannel = await res.json();
      channels.push(newChannel);
      renderChannels();
      overlay.classList.remove('visible');
      toast(`#${name} created`, 'success');
      selectChannel(newChannel.channel_id);
    } catch(e) {
      toast('failed to create channel', 'error');
    }
  }

  // â”€â”€â”€ TOAST â”€â”€â”€
  function toast(msg, type = '') {
    const container = document.getElementById('toastContainer');
    const el = document.createElement('div');
    el.className = 'toast ' + type;
    el.textContent = msg;
    container.appendChild(el);
    setTimeout(() => el.remove(), 3200);
  }

  // â”€â”€â”€ UTILS â”€â”€â”€
  function escHtml(str) {
    return String(str ?? '')
      .replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')
      .replace(/"/g,'&quot;');
  }

  // â”€â”€â”€ INIT â”€â”€â”€
  loadChannels();
  connectWS();
</script>
</body>
</html>
