<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>PokiChat</title>
  <link href="https://fonts.googleapis.com/css2?family=DM+Mono:wght@300;400;500&family=Syne:wght@400;600;800&display=swap" rel="stylesheet"/>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.6.1/sockjs.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
  <style>
    :root {
      --bg:       #0d0d0f;
      --surface:  #131316;
      --panel:    #18181d;
      --border:   #252530;
      --purple:   #7c3aed;
      --purple-dim:#4c1d95;
      --purple-glow: rgba(124, 58, 237, 0.18);
      --text:     #e8e8f0;
      --muted:    #555566;
      --accent:   #a78bfa;
    }

    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      background: var(--bg);
      color: var(--text);
      font-family: 'DM Mono', monospace;
      height: 100dvh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    /* Subtle noise overlay */
    body::before {
      content: '';
      position: fixed;
      inset: 0;
      background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.04'/%3E%3C/svg%3E");
      pointer-events: none;
      z-index: 1000;
      opacity: 0.4;
    }

    /* ─── Header ─── */
    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 28px;
      height: 58px;
      border-bottom: 1px solid var(--border);
      background: var(--surface);
      flex-shrink: 0;
    }

    .logo {
      font-family: 'Syne', sans-serif;
      font-weight: 800;
      font-size: 1.1rem;
      letter-spacing: 0.08em;
      color: var(--text);
    }

    .logo span { color: var(--accent); }

    .status-dot {
      width: 7px; height: 7px;
      border-radius: 50%;
      background: var(--muted);
      display: inline-block;
      margin-right: 8px;
      transition: background 0.4s;
    }

    .status-dot.connected { background: var(--accent); box-shadow: 0 0 6px var(--accent); }

    .status-label {
      font-size: 0.7rem;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      color: var(--muted);
      transition: color 0.4s;
    }

    .status-label.connected { color: var(--accent); }

    /* ─── Layout ─── */
    .layout {
      display: flex;
      flex: 1;
      overflow: hidden;
    }

    /* ─── Sidebar ─── */
    aside {
      width: 230px;
      flex-shrink: 0;
      border-right: 1px solid var(--border);
      background: var(--panel);
      display: flex;
      flex-direction: column;
      padding: 20px 0;
    }

    .sidebar-section {
      padding: 0 20px;
      margin-bottom: 24px;
    }

    .sidebar-label {
      font-size: 0.62rem;
      letter-spacing: 0.14em;
      text-transform: uppercase;
      color: var(--muted);
      margin-bottom: 12px;
    }

    .identity-block {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .avatar {
      width: 34px; height: 34px;
      border-radius: 6px;
      background: var(--purple-dim);
      border: 1px solid var(--purple);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.75rem;
      font-weight: 500;
      color: var(--accent);
      flex-shrink: 0;
      text-transform: uppercase;
    }

    .username-input {
      flex: 1;
      background: transparent;
      border: none;
      border-bottom: 1px solid var(--border);
      color: var(--text);
      font-family: 'DM Mono', monospace;
      font-size: 0.8rem;
      padding: 2px 0;
      outline: none;
      transition: border-color 0.2s;
    }

    .username-input:focus { border-color: var(--purple); }

    .online-list {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .online-user {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 5px 8px;
      border-radius: 5px;
      font-size: 0.75rem;
      color: var(--muted);
      opacity: 0;
      transform: translateX(-8px);
      animation: slideIn 0.3s forwards;
    }

    .online-user::before {
      content: '';
      width: 5px; height: 5px;
      border-radius: 50%;
      background: var(--accent);
      flex-shrink: 0;
    }

    @keyframes slideIn {
      to { opacity: 1; transform: translateX(0); }
    }

    /* ─── Chat Area ─── */
    main {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    #messages {
      flex: 1;
      overflow-y: auto;
      padding: 24px 28px;
      display: flex;
      flex-direction: column;
      gap: 2px;
      scroll-behavior: smooth;
    }

    #messages::-webkit-scrollbar { width: 4px; }
    #messages::-webkit-scrollbar-track { background: transparent; }
    #messages::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

    /* Date divider */
    .date-divider {
      text-align: center;
      font-size: 0.62rem;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      color: var(--muted);
      margin: 16px 0 8px;
      position: relative;
    }

    .date-divider::before,
    .date-divider::after {
      content: '';
      position: absolute;
      top: 50%;
      width: calc(50% - 60px);
      height: 1px;
      background: var(--border);
    }

    .date-divider::before { left: 0; }
    .date-divider::after  { right: 0; }

    /* Message bubble */
    .msg {
      display: flex;
      gap: 10px;
      padding: 6px 10px;
      border-radius: 6px;
      max-width: 720px;
      opacity: 0;
      transform: translateY(8px);
      animation: msgIn 0.25s ease forwards;
      transition: background 0.15s;
    }

    .msg:hover { background: rgba(255,255,255,0.025); }

    .msg.own { align-self: flex-end; flex-direction: row-reverse; }

    @keyframes msgIn {
      to { opacity: 1; transform: translateY(0); }
    }

    .msg-avatar {
      width: 28px; height: 28px;
      border-radius: 5px;
      background: var(--purple-dim);
      border: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.65rem;
      color: var(--accent);
      flex-shrink: 0;
      text-transform: uppercase;
      margin-top: 2px;
    }

    .msg.own .msg-avatar {
      background: rgba(124,58,237,0.3);
      border-color: var(--purple);
    }

    .msg-body { display: flex; flex-direction: column; gap: 2px; }

    .msg-meta {
      display: flex;
      align-items: baseline;
      gap: 8px;
    }

    .msg-user {
      font-size: 0.72rem;
      font-weight: 500;
      color: var(--muted);
      letter-spacing: 0.04em;
    }

    .msg.own .msg-user { color: var(--accent); }

    .msg-time {
      font-size: 0.6rem;
      color: var(--muted);
      opacity: 0.6;
    }

    .msg-text {
      font-size: 0.85rem;
      line-height: 1.55;
      color: var(--text);
      word-break: break-word;
    }

    /* ─── Input bar ─── */
    .input-bar {
      padding: 16px 24px;
      border-top: 1px solid var(--border);
      background: var(--surface);
      display: flex;
      gap: 12px;
      align-items: center;
    }

    #msgInput {
      flex: 1;
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 7px;
      color: var(--text);
      font-family: 'DM Mono', monospace;
      font-size: 0.85rem;
      padding: 10px 14px;
      outline: none;
      transition: border-color 0.2s, box-shadow 0.2s;
      resize: none;
    }

    #msgInput:focus {
      border-color: var(--purple);
      box-shadow: 0 0 0 3px var(--purple-glow);
    }

    #msgInput::placeholder { color: var(--muted); }

    #sendBtn {
      background: var(--purple);
      border: none;
      border-radius: 7px;
      color: #fff;
      font-family: 'Syne', sans-serif;
      font-weight: 600;
      font-size: 0.75rem;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      padding: 10px 20px;
      cursor: pointer;
      transition: background 0.2s, transform 0.1s, box-shadow 0.2s;
      flex-shrink: 0;
    }

    #sendBtn:hover  { background: #6d28d9; box-shadow: 0 0 16px var(--purple-glow); }
    #sendBtn:active { transform: scale(0.97); }
    #sendBtn:disabled { opacity: 0.35; cursor: not-allowed; }

    /* ─── System message ─── */
    .sys-msg {
      text-align: center;
      font-size: 0.68rem;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      color: var(--muted);
      padding: 6px 0;
    }

    .sys-msg span {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 20px;
      padding: 3px 12px;
    }

    /* ─── Empty state ─── */
    .empty-state {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 10px;
      color: var(--muted);
      opacity: 0.5;
    }

    .empty-icon {
      font-size: 2rem;
      filter: grayscale(1);
    }

    .empty-text {
      font-size: 0.72rem;
      letter-spacing: 0.1em;
      text-transform: uppercase;
    }
  </style>
</head>
<body>

<header>
  <div class="logo">POKI<span>CHAT</span></div>
  <div style="display:flex;align-items:center;gap:6px">
    <span class="status-dot" id="statusDot"></span>
    <span class="status-label" id="statusLabel">disconnected</span>
  </div>
</header>

<div class="layout">

  <aside>
    <div class="sidebar-section">
      <div class="sidebar-label">Identity</div>
      <div class="identity-block">
        <div class="avatar" id="sidebarAvatar">?</div>
        <input class="username-input" id="usernameInput" placeholder="your handle" maxlength="20" value=""/>
      </div>
    </div>
    <div class="sidebar-section">
      <div class="sidebar-label">Online</div>
      <div class="online-list" id="onlineList"></div>
    </div>
  </aside>

  <main>
    <div id="messages">
      <div class="empty-state" id="emptyState">
        <div class="empty-icon">◈</div>
        <div class="empty-text">no messages yet</div>
      </div>
    </div>

    <div class="input-bar">
      <input id="msgInput" placeholder="type a message…" maxlength="500" autocomplete="off"/>
      <button id="sendBtn" disabled>Send</button>
    </div>
  </main>

</div>

<script>
  // ─── Config ───────────────────────────────────────────────
  const WS_URL    = '/ws';       // SockJS endpoint
  const SEND_DEST = '/app/chat.sendMessage';
  const SUB_DEST  = '/chat/public';
  const API_URL   = '/chat';

  // ─── State ────────────────────────────────────────────────
  let stompClient = null;
  let username    = '';
  const onlineUsers = new Set();

  // ─── DOM refs ─────────────────────────────────────────────
  const messagesEl   = document.getElementById('messages');
  const msgInput     = document.getElementById('msgInput');
  const sendBtn      = document.getElementById('sendBtn');
  const statusDot    = document.getElementById('statusDot');
  const statusLabel  = document.getElementById('statusLabel');
  const usernameInput= document.getElementById('usernameInput');
  const sidebarAvatar= document.getElementById('sidebarAvatar');
  const onlineList   = document.getElementById('onlineList');
  const emptyState   = document.getElementById('emptyState');

  // ─── Username ─────────────────────────────────────────────
  function getUsername() {
    return usernameInput.value.trim() || 'anon';
  }

  usernameInput.addEventListener('input', () => {
    const val = getUsername();
    sidebarAvatar.textContent = val.charAt(0) || '?';
  });

  // ─── Connection ───────────────────────────────────────────
  function connect() {
    const socket = new SockJS(WS_URL);
    stompClient = Stomp.over(socket);
    stompClient.debug = null; // silence logs

    stompClient.connect({}, onConnected, onError);
  }

  function onConnected() {
    setStatus(true);
    stompClient.subscribe(SUB_DEST, onMessage);
    loadHistory();
  }

  function onError() {
    setStatus(false);
    setTimeout(connect, 3000); // auto-reconnect
  }

  function setStatus(connected) {
    statusDot.classList.toggle('connected', connected);
    statusLabel.classList.toggle('connected', connected);
    statusLabel.textContent = connected ? 'connected' : 'reconnecting…';
    sendBtn.disabled = !connected;
  }

  // ─── History ──────────────────────────────────────────────
  async function loadHistory() {
    try {
      const res = await fetch(API_URL);
      if (!res.ok) return;
      const msgs = await res.json();
      if (msgs && msgs.length) {
        appendDateDivider();
        msgs.forEach(m => renderMessage(m, false));
      }
    } catch (e) { /* server may not have REST yet */ }
  }

  // ─── Send ─────────────────────────────────────────────────
  function sendMessage() {
    const text = msgInput.value.trim();
    if (!text || !stompClient) return;

    const msg = { user: getUsername(), content: text };
    stompClient.send(SEND_DEST, {}, JSON.stringify(msg));
    msgInput.value = '';
    msgInput.focus();
  }

  sendBtn.addEventListener('click', sendMessage);

  msgInput.addEventListener('keydown', e => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      sendMessage();
    }
  });

  // ─── Receive ──────────────────────────────────────────────
  function onMessage(frame) {
    const msg = JSON.parse(frame.body);
    renderMessage(msg, true);
    trackUser(msg.user || 'anon');
  }

  // ─── Render ───────────────────────────────────────────────
  let lastDate = null;

  function appendDateDivider() {
    const today = new Date().toLocaleDateString('en-US', { weekday:'long', month:'short', day:'numeric' });
    if (today === lastDate) return;
    lastDate = today;

    const div = document.createElement('div');
    div.className = 'date-divider';
    div.textContent = today;
    messagesEl.appendChild(div);
  }

  function renderMessage(msg, live) {
    const user    = msg.user    || 'anon';
    const content = msg.content || '';
    const isOwn   = user === getUsername();

    if (live) appendDateDivider();

    // Hide empty state
    emptyState && emptyState.remove();

    const row = document.createElement('div');
    row.className = `msg${isOwn ? ' own' : ''}`;

    const now  = new Date();
    const time = now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: false });

    row.innerHTML = `
      <div class="msg-avatar">${user.charAt(0).toUpperCase()}</div>
      <div class="msg-body">
        <div class="msg-meta">
          <span class="msg-user">${escHtml(user)}</span>
          <span class="msg-time">${time}</span>
        </div>
        <div class="msg-text">${escHtml(content)}</div>
      </div>
    `;

    messagesEl.appendChild(row);
    messagesEl.scrollTop = messagesEl.scrollHeight;
  }

  // ─── Online users ─────────────────────────────────────────
  function trackUser(user) {
    if (onlineUsers.has(user)) return;
    onlineUsers.add(user);

    const el = document.createElement('div');
    el.className = 'online-user';
    el.textContent = user;
    onlineList.appendChild(el);
  }

  // ─── Utils ────────────────────────────────────────────────
  function escHtml(str) {
    return str
      .replace(/&/g,'&amp;')
      .replace(/</g,'&lt;')
      .replace(/>/g,'&gt;')
      .replace(/"/g,'&quot;');
  }

  // ─── Boot ─────────────────────────────────────────────────
  connect();
</script>
</body>
</html>
